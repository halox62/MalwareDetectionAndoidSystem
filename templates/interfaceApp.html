<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Detection Android</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lime@0.2.1/lime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shap@0.39.0/shap.min.js"></script>
    <style>
        #chart-container {
            width: 100%;
            height: 20cm; /* Altezza del grafico */
            margin-top: 20px;
        }
        canvas {
            height: 100%; /* Rende il canvas alto quanto il contenitore */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Malware Detection Android</h1>
        <div class="row">
            <div class="col-md-6 mb-3">
                <button id="train-original" class="btn btn-primary btn-block">Allenare il modello con i dati reali</button>
            </div>
            <div class="col-md-6 mb-3">
                <button id="train-emulated" class="btn btn-secondary btn-block">Allenare il modello con i dati emulati</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <button id="evaluate-original" class="btn btn-primary btn-block">Utilizzare un modello pre-addestrato con i dati reali</button>
            </div>
            <div class="col-md-6 mb-3">
                <button id="evaluate-emulated" class="btn btn-secondary btn-block">Utilizzare un modello pre-addestrato con i dati emulati</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <h3>Accuratezza del Modello</h3>
                <p id="model-accuracy" class="border p-3 mt-4">Accuratezza: Non disponibile</p>
            </div>
        </div>
        <div class="row">
            <div class="col-12 mb-3">
                <div id="training-log" class="border p-3" style="height: 300px; overflow-y: scroll;"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <h3>LIME Explanation</h3>
                <button id="show-lime-results" class="btn btn-info btn-block mb-3">Mostra Risultati LIME</button>
                <div id="chart-container">
                    <canvas id="lime-chart"></canvas>
                </div>
                <div id="lime-metadata" class="border p-3 mt-4">
                    <p id="lime-score"></p>
                    <p id="lime-predicted-class"></p>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            var socket = io.connect('http://' + document.domain + ':' + location.port);

            socket.on('training_log', function(data) {
                var logDiv = document.getElementById('training-log');
                logDiv.innerHTML += `<p>${data.message}</p>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            });
            function updateAccuracy(data) {
                // Mostra l'accuratezza
                document.getElementById('model-accuracy').textContent = `Accuratezza: ${data.accuracy}%`;
            }

            function updateChart(data) {
                const ctx = document.getElementById('lime-chart').getContext('2d');

                // Verifica se ci sono dati validi
                if (!data || !data.feature_names || data.feature_names.length === 0) {
                    console.error('Dati non validi per il grafico:', data);
                    return;
                }

                // Prendi le prime 20 feature se disponibili
                const numFeatures = Math.min(data.feature_names.length, 20);
                const features = data.feature_names.slice(0, numFeatures);
                const values = data.as_list.slice(0, numFeatures).map(item => item[1]);

                // Filtra le feature e i valori con valori non nulli
                const filteredFeatures = [];
                const filteredValues = [];
                const colors = [];

                for (let i = 0; i < values.length; i++) {
                    if (values[i] !== 0) {
                        filteredFeatures.push(features[i]);
                        filteredValues.push(values[i]);
                        colors.push(values[i] > 0 ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)');
                    }
                }

                // Se non ci sono dati validi, non creare il grafico
                if (filteredFeatures.length === 0) {
                    console.error('Nessuna feature valida per il grafico.');
                    return;
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: filteredFeatures,
                        datasets: [{
                            label: 'Valori delle Feature',
                            data: filteredValues,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 0.1
                                }
                            },
                            y: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        maintainAspectRatio: false,
                        responsive: true,
                        layout: {
                            padding: {
                                left: 10,
                                right: 10,
                                top: 10,
                                bottom: 10
                            }
                        },
                        elements: {
                            bar: {
                                barThickness: 10, // Barre piÃ¹ piccole
                                categoryPercentage: 0.7,
                                barPercentage: 0.5
                            }
                        }
                    }
                });

                // Mostra il punteggio e la classe predetta
                document.getElementById('lime-score').textContent = `Score: ${data.score}`;
                document.getElementById('lime-predicted-class').textContent = `Predicted Class: ${data.predicted_class}`;
            }

            document.getElementById('show-lime-results').addEventListener('click', function() {
                fetch('/lime', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    updateChart(data.lime_explanation); // Passa i dati al grafico
                })
                .catch(error => console.error('Error:', error));
            });

            // Gli altri eventi rimangono invariati
            document.getElementById('train-original').addEventListener('click', function() {
                fetch('/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'original'
                    })
                })
                .then(response => response.json())
                .catch(error => console.error('Error:', error));
            });

            document.getElementById('train-emulated').addEventListener('click', function() {
                fetch('/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'emulated'
                    })
                })
                .then(response => response.json())
                .catch(error => console.error('Error:', error));
            });

            document.getElementById('evaluate-original').addEventListener('click', function() {
                fetch('/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'original'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    updateAccuracy(data) 
                })
                .catch(error => console.error('Error:', error));
            });
            document.getElementById('evaluate-emulated').addEventListener('click', function() {
            fetch('/evaluate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'data_type': 'emulated'
                })
            })
            .then(response => response.json())
            .then(data => {
                updateAccuracy(data)
            })
            .catch(error => console.error('Error:', error));
        });
    });
    </script>
</body>
</html>
