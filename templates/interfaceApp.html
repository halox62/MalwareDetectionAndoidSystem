<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Detection Android</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lime@0.2.1/lime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shap@0.39.0/shap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>

        .button-container {
                display: flex;
                justify-content: center;
                gap: 20px; 
            }

        #chart-container {
            width: 100%;
            height: 20cm; 
            margin-top: 20px;
        }
        canvas {
            height: 100%; 
        }
        table {
            width: 50%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
       
       .button-container {
            margin-top: 40px; 
        }
       
        .btn {
            margin-top: 10px; 
        }
        #confusionMatrixContainer {
            margin-top: 30px; 
        }

    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Malware Detection Android</h1>
        <div class="row">
            <input type="text" id="user-inputTrain" class="form-control mb-3" placeholder="Inserisci numero di epoche per allenare il modello">
            <div class="col-md-6 mb-3">
                <button id="train-original" class="btn btn-primary btn-block">Allenare il modello con i dati reali</button>
            </div>
            <div class="col-md-6 mb-3">
                <button id="train-emulated" class="btn btn-secondary btn-block">Allenare il modello con i dati emulati</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <button id="evaluate-original" class="btn btn-primary btn-block">Utilizzare il modello con i dati reali</button>
            </div>
            <div class="col-md-6 mb-3">
                <button id="evaluate-emulated" class="btn btn-secondary btn-block">Utilizzare il modello con i dati emulati</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <h3>Accuratezza del Modello</h3>
                <p id="model-accuracy" class="border p-3 mt-4">Accuratezza: Non disponibile</p>
            </div>
        </div>
        <div class="row">
            <div class="col-12 mb-3">
                <div id="training-log" class="border p-3" style="height: 300px; overflow-y: scroll;"></div>
            </div>
        </div>

        <div class="container mt-5">
            <button id="classification-btn" class="btn btn-success btn-block mb-3">Get Classification Report</button>
            <div id="classification-report" class="border p-3 mt-4"></div>
            <div id="accuracy-report" class="border p-3 mt-4"></div>
            <div id="macro-avg-report" class="border p-3 mt-4"></div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <button id="showMatrixRealButton" class="btn btn-primary btn-block">Visualizza Matrice di confusione con i dati reali</button>
                </div>
                <div class="col-md-6 mb-3">
                    <button id="showMatrixEmulatedButton" class="btn btn-secondary btn-block">Visualizza Matrice di confusione con i dati emulati</button>
                </div>
            </div>
            <div id="confusionMatrixContainer" style="display: none;"></div>
        </div>
    
    
        <div class="row">
            <div class="col-md-12 mb-3">
                <h3>LIME Explanation</h3>
                <input type="text" id="user-input" class="form-control mb-3" placeholder="Inserisci indice feature">
                <button id="show-lime-results" class="btn btn-info btn-block mb-3">Mostra Risultati LIME</button>
                <div id="chart-container">
                    <canvas id="lime-chart"></canvas>
                </div>
                <div id="lime-metadata" class="border p-3 mt-4">
                    <p id="lime-score"></p>
                    <p id="lime-predicted-class"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function fetchAndDisplayConfusionMatrix(url) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const labels = data.labels;
                    const confusionMatrix = data.confusion_matrix;

                    let table = '<table class="table table-bordered">';
                    table += '<thead><tr><th></th>';
                    labels.forEach(label => table += `<th>${label}</th>`);
                    table += '</tr></thead><tbody>';

                    confusionMatrix.forEach((row, i) => {
                        table += `<tr><th>${labels[i]}</th>`;
                        row.forEach(value => table += `<td>${value}</td>`);
                        table += '</tr>';
                    });

                    table += '</tbody></table>';

                    document.getElementById('confusionMatrixContainer').innerHTML = table;
                    document.getElementById('confusionMatrixContainer').style.display = 'block';
                })
                .catch(error => console.error('Error fetching confusion matrix data:', error));
        }

        document.getElementById('showMatrixEmulatedButton').addEventListener('click', function() {
            fetchAndDisplayConfusionMatrix('/confusion_matrix_emulated');
        });

        document.getElementById('showMatrixRealButton').addEventListener('click', function() {
            fetchAndDisplayConfusionMatrix('/confusion_matrix_real');
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('training_log', function(data) {
        var logDiv = document.getElementById('training-log');
        logDiv.innerHTML += `<p>${data.message}</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    });

    function updateAccuracy(data) {
        // Mostra l'accuratezza
        document.getElementById('model-accuracy').textContent = `Accuratezza: ${data.accuracy.toFixed(4)}`;
    }

    let chartInstance = null; // Variabile per memorizzare l'istanza del grafico

    function updateChart(data) {
        const ctx = document.getElementById('lime-chart').getContext('2d');

        // Verifica se ci sono dati validi
        if (!data || !data.feature_names || data.feature_names.length === 0) {
            console.error('Dati non validi per il grafico:', data);
            return;
        }

        // Prendi le prime 20 feature se disponibili
        const numFeatures = Math.min(data.feature_names.length, 20);
        const features = data.feature_names.slice(0, numFeatures);
        const values = data.as_list.slice(0, numFeatures).map(item => item[1]);

        // Filtra le feature e i valori con valori non nulli
        const filteredFeatures = [];
        const filteredValues = [];
        const colors = [];

        for (let i = 0; i < values.length; i++) {
            if (values[i] !== 0) {
                filteredFeatures.push(features[i]);
                filteredValues.push(values[i]);
                colors.push(values[i] > 0 ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)');
            }
        }

        // Se non ci sono dati validi, non creare il grafico
        if (filteredFeatures.length === 0) {
            console.error('Nessuna feature valida per il grafico.');
            return;
        }

        // Distruggi il grafico precedente se esiste
        if (chartInstance) {
            chartInstance.destroy();
        }

        // Crea un nuovo grafico
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: filteredFeatures,
                datasets: [{
                    label: 'Valori delle Feature',
                    data: filteredValues,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 0.1
                        }
                    },
                    y: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                maintainAspectRatio: false,
                responsive: true,
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 10
                    }
                },
                elements: {
                    bar: {
                        barThickness: 10, // Barre più piccole
                        categoryPercentage: 0.7,
                        barPercentage: 0.5
                    }
                }
            }
        });

        // Mostra il punteggio e la classe predetta
        document.getElementById('lime-score').textContent = `Score: ${data.score.toFixed(4)}`;
        document.getElementById('lime-predicted-class').textContent = `Predicted Class: ${data.predicted_class}`;
    }

            document.getElementById('show-lime-results').addEventListener('click', function() {
                var userInput = document.getElementById('user-input').value;
                fetch('/lime', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'original',
                        'user_value': userInput  
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.lime_explanation.error) {
                        if (typeof chartInstance !== 'undefined' && chartInstance) {
                            chartInstance.destroy();
                        }
                        alert(data.lime_explanation.error); 
                    } else {
                        updateChart(data.lime_explanation);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    console.error('Error:', error);
                });
            });

    
            document.getElementById('train-original').addEventListener('click', function() {
                var userInputTrain = document.getElementById('user-inputTrain').value;
                fetch('/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'original',
                        'user_valueTrain': userInputTrain
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error);
                        });
                    }
                    return response.json();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    console.error('Error:', error);
                });
            });

            document.getElementById('train-emulated').addEventListener('click', function() {
                var userInputTrain = document.getElementById('user-inputTrain').value;
                fetch('/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'emulated',
                        'user_valueTrain': userInputTrain
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error);
                        });
                    }
                    return response.json();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    console.error('Error:', error);
                });
            });

            document.getElementById('evaluate-original').addEventListener('click', function() {
                fetch('/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'data_type': 'original'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    updateAccuracy(data) 
                })
                .catch(error => console.error('Error:', error));
            });
            document.getElementById('evaluate-emulated').addEventListener('click', function() {
            fetch('/evaluate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'data_type': 'emulated'
                })
            })
            .then(response => response.json())
            .then(data => {
                updateAccuracy(data)
            })
            .catch(error => console.error('Error:', error));
        });
        document.getElementById('classification-btn').addEventListener('click', function() {
            fetch('/classification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Tabella per le prime due righe
                    let htmlClassReport = '<table class="table table-bordered"><thead><tr>';
                    htmlClassReport += '<th>Class</th><th>Precision</th><th>Recall</th><th>F1-Score</th><th>Support</th></tr></thead><tbody>';
                    
                    // Aggiungi le righe per le classi
                    for (const [key, value] of Object.entries(data.classification_report)) {
                        if (key === '0' || key === '1') {
                            htmlClassReport += '<tr>';
                            htmlClassReport += `<td>${key}</td>`;
                            htmlClassReport += `<td>${value.precision.toFixed(4) || '-'}</td>`;
                            htmlClassReport += `<td>${value.recall.toFixed(4) || '-'}</td>`;
                            htmlClassReport += `<td>${value['f1-score'].toFixed(4) || '-'}</td>`;
                            htmlClassReport += `<td>${value.support || '-'}</td>`;
                            htmlClassReport += '</tr>';
                        }
                    }
                    
                    htmlClassReport += '</tbody></table>';
                    document.getElementById('classification-report').innerHTML = htmlClassReport;

                    // Tabella per l'accuratezza
                    let htmlAccuracy = '<table class="table table-bordered"><thead><tr>';
                    htmlAccuracy += '<th>Metric</th><th>Value</th></tr></thead><tbody>';
                    htmlAccuracy += `<tr><td>Accuracy</td><td>${data.classification_report.accuracy.toFixed(4)}</td></tr>`;
                    htmlAccuracy += '</tbody></table>';
                    document.getElementById('accuracy-report').innerHTML = htmlAccuracy;

                    // Tabella per la macro avg
                    let htmlMacroAvg = '<table class="table table-bordered"><thead><tr>';
                    htmlMacroAvg += '<th>Metric</th><th>Value</th></tr></thead><tbody>';
                    htmlMacroAvg += `<tr><td>F1-score(Macro Avg)</td><td>${data.classification_report['macro avg']['f1-score'].toFixed(4)}</td></tr>`;
                    htmlMacroAvg += '</tbody></table>';
                    document.getElementById('macro-avg-report').innerHTML = htmlMacroAvg;
                }
            })
            .catch(error => alert('Error fetching classification report: ' + error));
        });
    });

    
    </script>
</body>
</html>
